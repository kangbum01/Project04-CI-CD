---
- name: 1. 필수 시스템 패키지 설치
  ansible.builtin.dnf:
    name: 
      - ffmpeg
      - libsndfile
      - python3-pip
      - python3
    state: present
    update_cache: yes

- name: 2. NAS에서 소스 코드 동기화
  synchronize:
    src: "{{ nas_source_path }}/"
    dest: "{{ deploy_root }}/"
    recursive: yes
    rsync_opts:
      - "--exclude=venv"
      - "--exclude=__pycache__"
      - "--exclude=music-analyzer"

- name: 3. Python 가상환경 및 라이브러리 설치
  pip:
    name: [librosa, numpy, fastapi, uvicorn, python-multipart, transformers, torch]
    virtualenv: "{{ deploy_root }}/venv"
    virtualenv_command: python3 -m venv
  become_user: "{{ user_name }}"

- name: 4. systemd 서비스 유닛 파일 생성
  template:
    src: medw-api.service.j2
    dest: /etc/systemd/system/medw-api.service
    owner: root
    group: root
    mode: '0644'
  notify: reload and restart medw-api
