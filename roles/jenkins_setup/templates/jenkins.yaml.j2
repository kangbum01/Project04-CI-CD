jenkins:
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "${JENKINS_ADMIN_ID}"
          password: "${JENKINS_ADMIN_PW}"
  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousJobStatusPermission: false
  
  # ì „ì—­ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Ansible ì‹¤í–‰ìš©)
  globalNodeProperties:
    - envVars:
        env:
          - key: "ansible"
            value: "/usr/bin/ansible-playbook"
          - key: "PYTHONPATH"
            value: "/home/ansible-admin/.local/lib/python3.9/site-packages"
          - key: "ANSIBLE_HOST_KEY_CHECKING"
            value: "False"

# ë³´ì•ˆ ì„¤ì •: ë¡œì»¬ Git ì²´í¬ì•„ì›ƒ í—ˆìš© (ì•„ê¹Œ ë°œìƒí•œ ì—ëŸ¬ í•´ê²°)
unclassified:
  gitSCM:
    allowLocalCheckout: true
  location:
    url: http://localhost:8080/

# íŒŒì´í”„ë¼ì¸ Job ìë™ ìƒì„±
jobs:
  - script: >
      pipelineJob('Music-Service-Deploy') {
        definition {
          cps {
            script("""
              pipeline {
                agent any
                environment {
                  // ì‹¤íŒ¨ ë¡œê·¸ ì €ì¥ ê²½ë¡œ ì •ì˜
                  ERROR_LOG_PATH = "/home/ansible-admin/project/logs/deploy_error_\${BUILD_NUMBER}.log"
                }
                stages {
                  stage('Checkout') {
                    steps {
                      git branch: 'main', url: 'file:///home/ansible-admin/project/git/music-project.git'
                    }
                  }
                  stage('Deploy to Web Server') {
                    steps {
                      sh '''
                      export PYTHONPATH=/home/ansible-admin/.local/lib/python3.9/site-packages
                      export ANSIBLE_HOST_KEY_CHECKING=False
                      # Ansible ì‹¤í–‰ ê²°ê³¼ë¥¼ tee ëª…ë ¹ì–´ë¡œ í™”ë©´ê³¼ íŒŒì¼ ì–‘ìª½ì— ì¶œë ¥
                      \${ansible} -i /home/ansible-admin/project/init_setting/hosts.ini \
                      /home/ansible-admin/project/init_setting/deploy.yaml | tee ansible_output.log
                      '''
                    }
                  }
                }
                // [ì¶”ê°€] ë¹Œë“œ ê²°ê³¼ì— ë”°ë¥¸ í›„ì† ì¡°ì¹˜
                post {
                  success {
                    echo 'ğŸ‰ ë°°í¬ ì„±ê³µ! ì›¹ í˜ì´ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
                  }
                  failure {
                    echo 'ğŸš¨ ë°°í¬ ì‹¤íŒ¨! ì—ëŸ¬ ì›ì¸ì„ ë¶„ì„í•˜ì—¬ ë¡œê·¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.'
                    sh '''
                    mkdir -p /home/ansible-admin/project/logs
                    # ì‹¤íŒ¨í•œ ì‹œì ì˜ Ansible ë¡œê·¸ë¥¼ ì—ëŸ¬ ë¡œê·¸ í´ë”ë¡œ ë³µì‚¬
                    cp ansible_output.log \${ERROR_LOG_PATH}
                    echo "ì—ëŸ¬ ë¡œê·¸ ìœ„ì¹˜: \${ERROR_LOG_PATH}"
                    '''
                  }
                  always {
                    echo 'ë¹Œë“œ ê³¼ì • ì¢…ë£Œ (Build #\${BUILD_NUMBER})'
                  }
                }
              }
            """.stripIndent())
          }
        }
      }